# 勉強の動機
AWSやAzureなどクラウドサービスが話題になって久しいが、私はこれまでこれらを勉強したことがなかった。昨年、今いる現場からインフラ周りの世話をするDevOpsメンバーをボールドから出して欲しいとの要請を受け、メンバーの一人にそれをお願いした。その後、そのメンバーからDevOpsチームの状況を何度か確認したが、不勉強のため正確にその報告を理解することができなかった。特にメンバーの報告の中で鍵となっている言葉の一つであるTerraformはさっぱり分からなかった。このため、良い機会だとDevOpsなどを含めこれを勉強することとした。

# Terraformとは
Terraformとは、DevOpsの目的を実現するためのInfrastructure as Codeツールの一つである。まず、DevOpsとは何かから説明する。

## DevOpsとは
DevOpsとはDevelopment（開発）とOperations（運用）を組み合わせた造語であり、開発担当者と運用担当者が連携して協力する開発手法をいう。この造語が生まれた背景には、ハードウェアのソフトウェア化がある。ハードウェアのソフトウェア化とは、従来は物理的な機械だったコンピュータを仮想的な機械（ソフトウェア）で実現してしまうことだ。これにより１台の物理的なコンピュータの中に何台もの仮想的なコンピュータを載せることが可能となった。ハードウェアがソフトウェア化するとソフトウェア開発で培われた技術（バージョン管理など）を運用でも利用することが可能となった。この結果、開発と運用のの両者がより協力しあってソフトウェアのデリバリを今までより遥かに効率的にするというDevOpsの発想が生まれた。

## Infrastructure as Codeとは
ソフトウェアのデリバリを今までより遥かに効率的にするためには、従来は手動で行っていたソフトウェアのデリバリのプロセスを可能な限り自動化することが必要となる。このためのツールがIaC（Infrastructure as Code）と呼ばれるツールだ。IaCツールには大きく分けて次の4つのカテゴリがある。
* 設定管理ツール
* サーバテンプレーティングツール
* オーケストレーションツール
* プロビショニングツール

それぞれについて説明する。

### 設定管理ツール
Chef、Puppet、Ansible といったツールはどれも、既存のサーバ上にソフトウェアをインストー ルし、管理するための設定管理ツールだ。これらのツールは設定ファイルの内容にもとづきサーバにソフトウェアをインストールする。サーバをまとめてアップ デートできるローリングデプロイも可能となる。

### サーバテンプレーティングツール
設定管理ツールとは違った方法でサーバ上にソフトウェアをインストールするツールに、Docker、Packer、Vagrant といったサーバテンプレーティングツールがある。サーバをまとめて起動し、それぞれのサー バ上で同じコマンドを実行して設定する代わりに、サーバテンプレーティングツールは、OS、ソ フトウェア、ファイル、その他すべてを含んだ完全な「スナップショット」を使ったイメージを作るものだ。サーバテンプレーティングツールには、ハードウェアを含むコンピュータシステム全体のイメージ（仮想マシン）を利用するPacker や Vagrant といったツールと、より限定されたOS のユーザスペースのイメージ（コンテナ）を利用するDockerなどのツールがある。

### オーケストレーションツール
サーバテンプレーティングツールにより作られた仮想マシンやコンテナを管理するために作られたのがオーケストレーションツールと呼ばれるツールだ。例えば Kubernetes を使うと、Docker コンテナをどのように管 理するかをコードとして定義できるようになる。このため、主要なクラウドプロバイダのほとんどはKubernatesのネイティブサポートを提供している。

### プロビショニングツール
設定管理、サーバテンプレーティング、オーケストレーションツールは、各サーバで動くコード を定義するのに対して、Terraform、CloudFormation、OpenStack Heat といったプロビジョニ ングツールは、サーバ自身を作成する役割を持つ。プロビジョニングツールを使うと、データベース、キャッシュ、ロードバランサ、キュー、監視、サブネットの設定、ファイアウォール設定、ルーティングのルール、SSL 証明書、その他インフラに関するほとんどあらゆるものを作成できる。

## Terraformはどう動くのか
Terraform は、Hashicorp によって作られ、Go 言語で書かれたプロビショニングツールだ。Terraformは手元のPCに作成したTerraform設定ファイルの内容を元に、AWS、Azure、Google Cloudといったプロバイダに 対して インフラをデプロイする。このとき利用するTerraform設定ファイルはサーバの設定をTerraform独自の形式で記述したファイルだ。

# 実際のTerraform
実際にTerraformを利用して、クラウドのAWSに次のような環境をデプロイしたので、その報告をする。
* 2台のWebサーバ
* Webサーバの負荷を均等化するためのロードバランサ1台
* WebサーバからアクセスされるDBサーバ1台

これらの環境をTerraformを用いてAWS上に作るためには次の作業が必要となる。
* AWSアカウントのセットアップ
* Terraformのローカルマシンへのインストール
* Terrafrom設定ファイルの記述
* Terraformの実行

それぞれを簡単に解説する。

## AWSアカウントのセットアップ
AWSアカウントは、https://aws.amazon.com/jp/ を開き、メニューに沿ってメールアドレスや名前などの情報を入力することで取得できる。ただ、以前クラウドベースの統合開発環境であるCloud9に興味を持ったとき、その使い勝手が知るためにAWSのアカウントを作っていた。このため、今回はこのアカウントをそのまま利用することができた。AWSは一切お金がかからない無料枠のアカウントで利用することもできるが、有料枠のアカウントでも一定の制限を超えない場合は無料で利用できる。私が作成していたのは有料枠のアカウントだ。

## Terraformのローカルマシンへのインストール
私が普段利用しているPCはMacであり、ソフトウェアのインストールにはHomebrewというパッケージマネージャが利用できる。Terraformのインストールは下記のコマンドを実行するだけだ。
* brew tap hashicorp/tap
* brew install hashicorp/tap/terraform

## Terrafrom設定ファイルの記述
Terraform設定ファイルは、作成するサーバの内容をTerraform独自の形式で記述した拡張子 .tf  のファイルだ。このファイルの文字コードはUTF-8の限定されており、改行コードはLFが推奨されている（CRLFも問題なく使用できる）。
私が作成したTerraform設定ファイルは githubにアップロードしたため、下記のURLで内容を確認することができる。
https://github.com/umidori/Terraform

## Terraformの実行
私の記述したTerraform設定ファイルからAWSクラウドにサーバを作成するには、main.tfファイルが存在する下記の3つのディレクトリのそれぞれで、terraform apply コマンドを実行するだけだ。

* live/global/s3/main.tf
* live/stage/data-stores/mysql/main.tf
* live/stage/services/webserver-cluster/main.tf

上記コマンドによりサーバの稼働を確認するには、作成されたロードバランサのDNS名をWebブラウザのURLに指定すると良い。指定するURL名は下記の通り。

* http://terraform-asg-example-559934395.ap-northeast-1.elb.amazonaws.com

上記URLをブラウザに指定すると下記の内容が表示される。

Hello, World

DB address: terraform-up-and-running20240526112702590800000001.cjoqq4ym2bhp.ap-northeast-1.rds.amazonaws.com

DB port: 3306

# Terraformを試してみた感想
Terraformは宣言型のIaCツールと言われている。宣言型のツールは最終的なサーバのイメージを記述すると、現在のサーバの状態と最終的な状態との差分をツールが検出し、その差分のみを実施する。今回、Terraformを試してみてその点は確かに便利だと感じた。今後はさらに研究を進め、宣言型のツールの弱点やその対策まで探ることができると良いと感じている。
